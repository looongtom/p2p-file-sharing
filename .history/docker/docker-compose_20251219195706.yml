services:
  tracker:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: bt-tracker
    command: ["python","tracker/tracker.py"]
    environment:
      TRACKER_PORT: "12345"
      TRACKER_DB_DIR: "/app/tracker_db"
      TRACKER_TTL_SEC: "60"
    ports:
      - "12345:12345/udp"
    volumes:
      - ../data/tracker_db:/app/tracker_db
    networks: [bt-net]

  peer1:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: bt-peer1
    command: ["python","peer/node.py","-node_id","1"]
    environment:
      TRACKER_HOST: "tracker"
      TRACKER_PORT: "12345"
      ADVERTISE_HOST: "peer1"
      NODE_PORT: "20001"
      PIECE_SIZE: "262144"
      BLOCK_SIZE: "8192"
      SEED_DIR: "node_files"
      DOWNLOAD_DIR: "downloads"
    ports:
      - "20001:20001/udp"
      - "5001:5000"  # Flask API port
    volumes:
      - ../data/peer1/node_files:/app/node_files
      - ../data/peer1/downloads:/app/downloads
    depends_on: [tracker]
    networks: [bt-net]
    tty: true
    stdin_open: true

  peer2:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: bt-peer2
    command: ["python","peer/node.py","-node_id","2"]
    environment:
      TRACKER_HOST: "tracker"
      TRACKER_PORT: "12345"
      ADVERTISE_HOST: "peer2"
      NODE_PORT: "20002"
      PIECE_SIZE: "262144"
      BLOCK_SIZE: "8192"
      SEED_DIR: "node_files"
      DOWNLOAD_DIR: "downloads"
    ports:
      - "20002:20002/udp"
    volumes:
      - ../data/peer2/node_files:/app/node_files
      - ../data/peer2/downloads:/app/downloads
    depends_on: [tracker]
    networks: [bt-net]
    tty: true
    stdin_open: true

  peer3:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: bt-peer3
    command: ["python","peer/node.py","-node_id","3"]
    environment:
      TRACKER_HOST: "tracker"
      TRACKER_PORT: "12345"
      ADVERTISE_HOST: "peer3"
      NODE_PORT: "20003"
      PIECE_SIZE: "262144"
      BLOCK_SIZE: "8192"
      SEED_DIR: "node_files"
      DOWNLOAD_DIR: "downloads"
    ports:
      - "20003:20003/udp"
    volumes:
      - ../data/peer3/node_files:/app/node_files
      - ../data/peer3/downloads:/app/downloads
    depends_on: [tracker]
    networks: [bt-net]
    tty: true
    stdin_open: true

networks:
  bt-net:
    driver: bridge
